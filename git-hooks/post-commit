#!/bin/bash
# code-rag-mcp git hook - post-commit
# Automatically re-indexes changed files after each commit

# Configuration
CODE_RAG_HTTP_PORT="${CODE_RAG_HTTP_PORT:-9333}"
CODE_RAG_HTTP_HOST="${CODE_RAG_HTTP_HOST:-localhost}"

echo "üîç code-rag: Detecting changed files..."

# Get files changed in the last commit
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)

# Filter by extensions we care about
EXTENSIONS="\.js$|\.jsx$|\.ts$|\.tsx$|\.go$|\.py$|\.md$|\.tf$|\.yaml$|\.yml$|\.json$"
FILES_TO_REINDEX=$(echo "$CHANGED_FILES" | grep -E "$EXTENSIONS")

if [ -z "$FILES_TO_REINDEX" ]; then
  echo "‚úÖ No code files changed, skipping re-indexing"
  exit 0
fi

# Count files
FILE_COUNT=$(echo "$FILES_TO_REINDEX" | wc -l | tr -d ' ')
echo "üìù $FILE_COUNT file(s) to re-index..."

# Get absolute paths
REPO_ROOT=$(git rev-parse --show-toplevel)
ABSOLUTE_FILES=()

while IFS= read -r file; do
  # Skip if file was deleted
  if [ -f "$REPO_ROOT/$file" ]; then
    ABSOLUTE_FILES+=("$REPO_ROOT/$file")
  fi
done <<< "$FILES_TO_REINDEX"

if [ ${#ABSOLUTE_FILES[@]} -eq 0 ]; then
  echo "‚úÖ All changed files were deleted, nothing to index"
  exit 0
fi

echo "üì§ Files to re-index:"
for file in "${ABSOLUTE_FILES[@]}"; do
  echo "   - $(basename $file)"
done

# Try to call HTTP API for immediate re-indexing
API_URL="http://${CODE_RAG_HTTP_HOST}:${CODE_RAG_HTTP_PORT}/reindex"

# Build JSON payload
JSON_FILES=$(printf '%s\n' "${ABSOLUTE_FILES[@]}" | jq -R . | jq -s .)
JSON_PAYLOAD="{\"files\": $JSON_FILES}"

# Check if API is available and call it
if curl -s --connect-timeout 2 "http://${CODE_RAG_HTTP_HOST}:${CODE_RAG_HTTP_PORT}/health" > /dev/null 2>&1; then
  echo "üîÑ Calling code-rag HTTP API for immediate re-indexing..."
  
  RESPONSE=$(curl -s -X POST \
    -H "Content-Type: application/json" \
    -d "$JSON_PAYLOAD" \
    "$API_URL" 2>&1)
  
  if echo "$RESPONSE" | jq -e '.success' > /dev/null 2>&1; then
    FILES_INDEXED=$(echo "$RESPONSE" | jq -r '.files_indexed')
    echo "‚úÖ Re-indexed $FILES_INDEXED file(s) successfully"
    exit 0
  else
    echo "‚ö†Ô∏è  API call failed, falling back to marker file"
    echo "    Response: $RESPONSE"
  fi
else
  echo "‚ö†Ô∏è  code-rag HTTP API not available at $API_URL"
  echo "    Make sure code-rag-mcp is running with HTTP API enabled"
fi

# Fallback: Create marker file for deferred re-indexing
MARKER_FILE="$REPO_ROOT/.code-rag-pending-reindex"
printf '%s\n' "${ABSOLUTE_FILES[@]}" | tr '\n' ' ' > "$MARKER_FILE"
echo "üìã Re-index request queued in marker file"
echo "   Will be processed on next MCP server start or via:"
echo "   curl -X POST http://${CODE_RAG_HTTP_HOST}:${CODE_RAG_HTTP_PORT}/reindex-pending?workdir=$REPO_ROOT"

exit 0
